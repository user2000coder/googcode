<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªï sung d·ªØ li·ªáu b√°o c√°o - Qu·∫£n l√Ω kho PE</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <style>
        html, body {
            height: 100%; 
            margin: 0; 
            padding: 0;
        }
        body { 
            font-family: 'Roboto', Arial, sans-serif; 
            background: #f4f8fd; 
            margin: 0; 
        }
        .container, .main-container, .nk-container {
            max-width: 1200px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(25,118,210,0.08);
            padding: 32px 20px;
        }
        h1, h2, h3, h4, h5, h6, label, th {
            color: #1976d2;
        }
        button, .nk-btn-main {
            background: linear-gradient(90deg, #1976d2 0%, #1565c0 100%) !important;
            color: #fff !important;
            border: none;
            border-radius: 8px;
            padding: 12px 28px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 8px;
            transition: transform 0.2s;
        }
        button:hover, .nk-btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25,118,210,0.3);
        }
        .nk-form {
            display: flex;
            flex-wrap: wrap;
            gap: 18px 32px;
            justify-content: center;
            margin-bottom: 18px;
            background: #f4f8fd;
            padding: 18px 12px 12px 12px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(25,118,210,0.06);
        }
        .nk-form-group {
            flex: 1 1 320px;
            min-width: 260px;
            max-width: 360px;
            display: flex;
            flex-direction: column;
        }
        .nk-form-group label {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        .nk-form-group input, .nk-form-group select, .nk-form-group textarea {
            padding: 10px 12px;
            border: 1px solid #b6c6e3;
            border-radius: 8px;
            font-size: 1rem;
            background: #fafdff;
            transition: border-color 0.2s;
        }
        .nk-form-group input:focus, .nk-form-group select:focus, .nk-form-group textarea:focus {
            border-color: #1976d2;
            outline: none;
            box-shadow: 0 0 0 2px rgba(25,118,210,0.1);
        }
        .nk-form-group textarea { 
            min-height: 38px; 
        }
        .nk-title {
            text-align: center;
            color: #1976d2;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        .nk-title span {
            font-size: 1.6rem;
            margin-right: 8px;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        .loading {
            background: #e3f2fd;
            color: #1976d2;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        #result {
            min-height: 20px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <nav>
        <div>
            <div class="nav-logo">
                <img src="/static/SUMIDA-LOGO.jpg" alt="Sumida Logo" style="max-height:48px;width:auto;" />
                <a href="/" style="font-weight:700;font-size:1.18rem;">üìÅ Trang ch·ªß</a>
            </div>
            <div class="nav-menu">
                <a href="/nhap-kho">Nh·∫≠p kho</a>
                <a href="/xuat-kho">Xu·∫•t kho</a>
                <a href="/danh-sach">L·ªãch s·ª≠</a>
                <a href="/bao-cao">B√°o c√°o</a>
                <a href="/kiem-ke">Ki·ªÉm k√™ kho</a>
                <a href="/bo-sung-du-lieu">B·ªï sung d·ªØ li·ªáu</a>
            </div>
        </div>
    </nav>

    <div class="nk-container">
        <h1 class="nk-title"><span>üìù</span> B·ªï sung d·ªØ li·ªáu v√†o b√°o c√°o (30 c·ªôt)</h1>
        
        <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1976d2;">
            <h3 style="margin: 0 0 8px 0; color: #1976d2;">üìã H∆∞·ªõng d·∫´n:</h3>
            <p style="margin: 0; color: #1565c0;">
                ‚Ä¢ Nh·∫≠p <strong>Specification</strong> tr∆∞·ªõc ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin (n·∫øu v·∫≠t t∆∞ ƒë√£ t·ªìn t·∫°i)<br>
                ‚Ä¢ T·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë·ªÅu l√† t√πy ch·ªçn - ƒëi·ªÅn th√¥ng tin theo nhu c·∫ßu<br>
                ‚Ä¢ Form ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi c·∫•u tr√∫c 30 c·ªôt ch√≠nh x√°c
            </p>
        </div>

        <form id="report-form" class="nk-form">
            <!-- Th√¥ng tin c∆° b·∫£n -->
            <div class="nk-form-group">
                <label>Group use (Nh√≥m s·ª≠ d·ª•ng):</label>
                <input type="text" id="group_name" name="group_name" placeholder="Nh·∫≠p nh√≥m s·ª≠ d·ª•ng">
            </div>
            <div class="nk-form-group">
                <label>Product code (M√£ h√†ng):</label>
                <input type="text" id="product_code" name="product_code" placeholder="Nh·∫≠p m√£ h√†ng">
            </div>
            <div class="nk-form-group">
                <label>Classify (Ph√¢n lo·∫°i BU):</label>
                <input type="text" id="classification" name="classification" placeholder="Nh·∫≠p ph√¢n lo·∫°i BU">
            </div>
            <div class="nk-form-group">
                <label>Part Code:</label>
                <input type="text" id="part_code" name="part_code" placeholder="Nh·∫≠p m√£ chi ti·∫øt">
            </div>
            <div class="nk-form-group">
                <label>Material name (T√™n h√†ng h√≥a):</label>
                <input type="text" id="material_name" name="material_name" placeholder="Nh·∫≠p t√™n v·∫≠t t∆∞">
            </div>
            <div class="nk-form-group">
                <label>Specification/Drawing (Th√¥ng s·ªë k·ªπ thu·∫≠t) üîç:</label>
                <input type="text" id="specification" name="specification" placeholder="Nh·∫≠p th√¥ng s·ªë k·ªπ thu·∫≠t v√† nh·∫•n Tab ƒë·ªÉ auto-fill" 
                       title="Nh·∫≠p specification v√† nh·∫•n Tab ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin n·∫øu v·∫≠t t∆∞ ƒë√£ t·ªìn t·∫°i">
                <small style="color: #666; font-size: 0.85em;">üí° G·ª£i √Ω: Th·ª≠ nh·∫≠p "Thread: M6x1.0, Tube OD: 8mm, Material: Brass, Max Pressure: 1.0MPa"</small>
            </div>
            <div class="nk-form-group">
                <label>Brand (Nh√† SX):</label>
                <input type="text" id="brand_name" name="brand_name" placeholder="Nh·∫≠p nh√† s·∫£n xu·∫•t">
            </div>
            <div class="nk-form-group">
                <label>Unit (ƒê∆°n v·ªã):</label>
                <input type="text" id="unit" name="unit" placeholder="Nh·∫≠p ƒë∆°n v·ªã (pcs, kg, m...)">
            </div>

            <!-- Th√¥ng tin t·ªìn kho -->
            <div class="nk-form-group">
                <label>Opening stock (T·ªìn ƒë·∫ßu k·ª≥):</label>
                <input type="number" id="opening_stock" name="opening_stock" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Input (Nh·∫≠p):</label>
                <input type="number" id="input" name="input" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Output (Xu·∫•t):</label>
                <input type="number" id="output" name="output" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Closing stock (T·ªìn cu·ªëi k·ª≥):</label>
                <input type="number" id="closing_stock" name="closing_stock" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Inventory (Ki·ªÉm k√™):</label>
                <input type="number" id="inventory" name="inventory" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Location (V·ªã tr√≠):</label>
                <input type="text" id="location" name="location" placeholder="A1-B2-C3">
            </div>
            <div class="nk-form-group">
                <label>Safety Stock (T·ªìn kho an to√†n):</label>
                <input type="number" id="safety_stock" name="safety_stock" placeholder="0" step="any" value="0">
            </div>

            <!-- Th√¥ng tin mua h√†ng -->
            <div class="nk-form-group">
                <label>Purchase SE (SE mua h√†ng):</label>
                <input type="text" id="purchase_se" name="purchase_se" placeholder="Nh·∫≠p SE mua h√†ng">
            </div>
            <div class="nk-form-group">
                <label>Purchase Order (ƒê∆°n h√†ng mua):</label>
                <input type="text" id="purchase_order" name="purchase_order" placeholder="Nh·∫≠p s·ªë PO">
            </div>

            <!-- Th√¥ng tin chi ph√≠ -->
            <div class="nk-form-group">
                <label>Cost opening stock (Chi ph√≠ t·ªìn ƒë·∫ßu k·ª≥):</label>
                <input type="number" id="cost_opening_stock" name="cost_opening_stock" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Cost Input (Chi ph√≠ nh·∫≠p):</label>
                <input type="number" id="cost_input" name="cost_input" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Cost Output (Chi ph√≠ xu·∫•t):</label>
                <input type="number" id="cost_output" name="cost_output" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Cost closing stock (Chi ph√≠ t·ªìn cu·ªëi k·ª≥):</label>
                <input type="number" id="cost_closing_stock" name="cost_closing_stock" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Cost safety stock (Chi ph√≠ t·ªìn kho an to√†n):</label>
                <input type="number" id="cost_safety_stock" name="cost_safety_stock" placeholder="0" step="any" value="0">
            </div>

            <!-- Th√¥ng tin gi√° -->
            <div class="nk-form-group">
                <label>Price (Gi√°):</label>
                <input type="number" id="price" name="price" placeholder="0" step="any" value="0">
            </div>
            <div class="nk-form-group">
                <label>Currency (Ti·ªÅn t·ªá):</label>
                <select id="currency" name="currency">
                    <option value="VND" selected>VND</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="JPY">JPY</option>
                </select>
            </div>

            <!-- Th√¥ng tin ng∆∞·ªùi nh·∫≠p -->
            <div class="nk-form-group">
                <label>Imported by (Ng∆∞·ªùi nh·∫≠p):</label>
                <input type="text" id="imported_by" name="imported_by" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠p">
            </div>

            <!-- Th√¥ng tin h·ªá th·ªëng (ch·ªâ ƒë·ªçc) -->
            <div class="nk-form-group">
                <label>Last update (C·∫≠p nh·∫≠t cu·ªëi):</label>
                <input type="datetime-local" id="last_update" name="last_update" readonly style="background: #f5f5f5;">
            </div>
            <div class="nk-form-group">
                <label>Last time (Th·ªùi gian cu·ªëi):</label>
                <input type="datetime-local" id="last_time" name="last_time" readonly style="background: #f5f5f5;">
            </div>

            <div style="width: 100%; text-align: center; margin-top: 20px;">
                <button type="button" id="autofillBtn" class="nk-btn-main" style="margin-right: 16px;">üîç Autofill</button>
                <button type="submit" class="nk-btn-main">üíæ L∆∞u d·ªØ li·ªáu v√†o b√°o c√°o</button>
            </div>
        </form>

        <div id="result" style="text-align:center;font-weight:600;margin-top:20px;"></div>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="/bao-cao" style="color: #1976d2; text-decoration: none; font-weight: 600;">
                üìã Xem b√°o c√°o 30 c·ªôt
            </a> | 
            <a href="/" style="color: #1976d2; text-decoration: none; font-weight: 600;">
                üè† V·ªÅ trang ch·ªß
            </a>
        </div>
    </div>

    <script>
        // Set current time for last_update and last_time fields when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const currentDateTime = now.toISOString().slice(0, 16);
            document.getElementById('last_update').value = currentDateTime;
            document.getElementById('last_time').value = currentDateTime;
        });

        // Form submission handler
        document.getElementById('report-form').onsubmit = async function(e) {
            e.preventDefault();
            console.log('Form submitted');

            // Collect form data - exactly matching the 30-column structure
            const data = {
                group_name: document.getElementById('group_name').value,
                product_code: document.getElementById('product_code').value,
                classification: document.getElementById('classification').value,
                part_code: document.getElementById('part_code').value,
                material_name: document.getElementById('material_name').value,
                specification: document.getElementById('specification').value,
                brand_name: document.getElementById('brand_name').value,
                unit: document.getElementById('unit').value,
                opening_stock: document.getElementById('opening_stock').value,
                input: document.getElementById('input').value,
                output: document.getElementById('output').value,
                closing_stock: document.getElementById('closing_stock').value,
                inventory: document.getElementById('inventory').value,
                location: document.getElementById('location').value,
                safety_stock: document.getElementById('safety_stock').value,
                purchase_se: document.getElementById('purchase_se').value,
                purchase_order: document.getElementById('purchase_order').value,
                cost_opening_stock: document.getElementById('cost_opening_stock').value,
                cost_input: document.getElementById('cost_input').value,
                cost_output: document.getElementById('cost_output').value,
                cost_closing_stock: document.getElementById('cost_closing_stock').value,
                cost_safety_stock: document.getElementById('cost_safety_stock').value,
                price: document.getElementById('price').value,
                currency: document.getElementById('currency').value,
                imported_by: document.getElementById('imported_by').value,
                last_update: document.getElementById('last_update').value,
                last_time: document.getElementById('last_time').value
            };
            
            console.log('Form data:', data);

            // Show loading indicator
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">‚è≥ ƒêang l∆∞u d·ªØ li·ªáu...</div>';
            
            try {
                console.log('Sending request...');
                const response = await fetch('/bo-sung-bao-cao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y');
                    } else if (response.status === 403) {
                        throw new Error('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán ch·ª©c nƒÉng n√†y');
                    } else {
                        throw new Error(`L·ªói server: ${response.status}`);
                    }
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.status === 'success') {
                    resultDiv.innerHTML = `<div class="success">‚úÖ ${result.message || 'B·ªï sung d·ªØ li·ªáu b√°o c√°o th√†nh c√¥ng!'}</div>`;
                    
                    // Reset form after successful submission
                    document.getElementById('report-form').reset();
                    
                    // Reset datetime fields
                    const now = new Date();
                    const currentDateTime = now.toISOString().slice(0, 16);
                    document.getElementById('last_update').value = currentDateTime;
                    document.getElementById('last_time').value = currentDateTime;
                    document.getElementById('currency').value = 'VND';
                    
                    // Show success message for 5 seconds then fade out
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 5000);
                    
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå ${result.message || 'C√≥ l·ªói x·∫£y ra!'}</div>`;
                }
            } catch (err) {
                console.error('Fetch error:', err);
                resultDiv.innerHTML = `<div class="error">‚ùå ${err.message}</div>`;
            }
            return false;
        }

        // T√°ch ch·ª©c nƒÉng autofill ra n√∫t ri√™ng
        document.getElementById('autofillBtn').addEventListener('click', function() {
            const specificationInput = document.getElementById('specification');
            const specification = specificationInput.value.trim();
            if (!specification) {
                alert('Vui l√≤ng nh·∫≠p Specification tr∆∞·ªõc khi autofill!');
                return;
            }
            // Hi·ªán loading
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loading-msg';
            loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1976d2;color:white;padding:15px 25px;border-radius:10px;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
            loadingMsg.innerHTML = 'üîç ƒêang t√¨m ki·∫øm th√¥ng tin v·∫≠t t∆∞...<br><small>Vui l√≤ng ƒë·ª£i...</small>';
            document.body.appendChild(loadingMsg);
            const searchUrl = `/api/search-material?specification=${encodeURIComponent(specification)}`;
            fetch(searchUrl)
                .then(response => response.json())
                .then(data => {
                    const loading = document.getElementById('loading-msg');
                    if (loading) loading.remove();
                    if (data.status === 'success' && data.material) {
                        const material = data.material;
                        if (confirm(`ƒê√£ t√¨m th·∫•y v·∫≠t t∆∞:\nüè∑Ô∏è T√™n: ${material.material_name || 'N/A'}\nüì¶ M√£ h√†ng: ${material.product_code || 'N/A'}\nüè¢ Nh√≥m: ${material.group_name || 'N/A'}\nüè≠ Nh√† SX: ${material.brand_name || 'N/A'}\n\nB·∫°n c√≥ mu·ªën t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin kh√¥ng?`)) {
                            const fieldsToFill = [
                                'group_name', 'product_code', 'classification', 'part_code', 
                                'material_name', 'brand_name', 'unit', 'location',
                                'opening_stock', 'input', 'output', 'closing_stock', 
                                'inventory', 'safety_stock', 'purchase_se', 'purchase_order', 
                                'cost_opening_stock', 'cost_input', 'cost_output', 'cost_closing_stock', 
                                'cost_safety_stock', 'price', 'currency', 'imported_by'
                            ];
                            let filledCount = 0;
                            fieldsToFill.forEach(fieldName => {
                                const element = document.getElementById(fieldName);
                                if (element && material[fieldName] != null && material[fieldName] !== '') {
                                    element.value = material[fieldName];
                                    filledCount++;
                                }
                            });
                            const now = new Date().toISOString().slice(0, 16);
                            document.getElementById('last_update').value = now;
                            document.getElementById('last_time').value = now;
                            const successMsg = document.createElement('div');
                            successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#4caf50;color:white;padding:15px 25px;border-radius:10px;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                            successMsg.innerHTML = `‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn ${filledCount} tr∆∞·ªùng th√¥ng tin!<br><small>Ki·ªÉm tra v√† ch·ªânh s·ª≠a n·∫øu c·∫ßn</small>`;
                            document.body.appendChild(successMsg);
                            setTimeout(() => successMsg.remove(), 5000);
                        }
                    } else if (data.status === 'not_found') {
                        const infoMsg = document.createElement('div');
                        infoMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:15px 25px;border-radius:10px;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                        infoMsg.innerHTML = 'üÜï ƒê√¢y l√† v·∫≠t t∆∞ m·ªõi<br><small>Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin</small>';
                        document.body.appendChild(infoMsg);
                        setTimeout(() => infoMsg.remove(), 4000);
                    } else {
                        const errorMsg = document.createElement('div');
                        errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#f44336;color:white;padding:15px 25px;border-radius:10px;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                        errorMsg.innerHTML = `‚ùå L·ªói: ${data.message}<br><small>Vui l√≤ng th·ª≠ l·∫°i</small>`;
                        document.body.appendChild(errorMsg);
                        setTimeout(() => errorMsg.remove(), 4000);
                    }
                })
                .catch(error => {
                    const loading = document.getElementById('loading-msg');
                    if (loading) loading.remove();
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#f44336;color:white;padding:15px 25px;border-radius:10px;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
                    errorMsg.innerHTML = '‚ùå L·ªói k·∫øt n·ªëi<br><small>Kh√¥ng th·ªÉ t√¨m ki·∫øm th√¥ng tin v·∫≠t t∆∞</small>';
                    document.body.appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 4000);
                });
        });
    </script>
    
    <footer class="footer">
        Ph√°t tri·ªÉn b·ªüi SEQPE
    </footer>
</body>
</html>
