<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o t·ªìn kho - Qu·∫£n l√Ω kho PEs</title>    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <style>
        body {font-family: 'Roboto', Arial, sans-serif; background: #f4f8fd; margin: 0; }
        .container, .main-container {
            max-width: 1200px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(25,118,210,0.08);
            padding: 32px 20px;
        }
        h1, h2, h3, h4, h5, h6, label, th {
            color: #1976d2;
        }
        button, .quick-btn, .export-btn {
            background: #1976d2 !important;
            color: #fff !important;
        }
        .stat-card {
            background: #1976d2 !important;
            color: #fff !important;
        }
        .quick-actions, .recent-activity, .alerts-section {
            background: #fff !important;
        }
        .success { color: #388e3c; }
        .error { color: #d32f2f; }
        table { width: 100%; border-collapse: collapse; margin-top: 18px; }
        th, td { border: 1px solid #b6c6e3; padding: 8px 10px; text-align: center; }
        th { background: #e3f0ff; color: #1976d2; }
        tr:nth-child(even) { background: #f4f8fd; }
    </style>
</head>
<body style="background:#f4f8fd;">
<nav>
    <div>
        <div class="nav-logo">
            <img src="/static/SUMIDA-LOGO.jpg" alt="Sumida Logo" style="max-height:48px;width:auto;" />
            <a href="/" style="font-weight:700;font-size:1.18rem;">üìÅ Trang ch·ªß</a>
        </div>
        <div class="nav-menu">
            <a href="/nhap-kho">Nh·∫≠p kho</a>
            <a href="/xuat-kho">Xu·∫•t kho</a>
            <a href="/danh-sach">L·ªãch s·ª≠</a>
            <a href="/bao-cao">B√°o c√°o</a>
            <a href="/kiem-ke">Ki·ªÉm k√™ kho</a>
            <a href="/bo-sung-du-lieu">B·ªï sung d·ªØ li·ªáu</a>
        </div>
    </div>
</nav>
<div style="display:flex;justify-content:center;align-items:flex-start;min-height:100vh;width:100vw;">
    <div class="container" style="background:#fff;max-width:1400px;width:98vw;margin:40px auto 32px auto;border-radius:18px;box-shadow:0 4px 24px rgba(0,0,0,0.10);padding:32px 18px 32px 18px;">
        <h1 style="color:#1976d2;margin-bottom:18px;text-align:center;">B√°o c√°o t·ªìn kho - Qu·∫£n l√Ω kho PE</h1>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
            <div style="display:flex;gap:8px;align-items:center;width:100%;max-width:400px;">
                <input type="text" id="report-search" placeholder="T√¨m ki·∫øm nhanh..." style="padding:8px 12px;width:100%;max-width:350px;border-radius:8px;border:1px solid #b6c6e3;">
                <button id="delete-selected" style="padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;">üóë X√≥a</button>
            </div>            <button id="save-all-btn" style="background:#388e3c;color:#fff;padding:10px 22px;border-radius:8px;font-weight:600;box-shadow:0 2px 8px rgba(56,142,60,0.10);">üíæ L∆∞u t·∫•t c·∫£</button>
            <a href="/bao-cao-xls" class="export-btn" style="background:#1976d2;color:#fff;padding:10px 22px;border-radius:8px;text-decoration:none;font-weight:600;box-shadow:0 2px 8px rgba(25,118,210,0.10);transition:background 0.2s;">‚¨á Xu·∫•t Excel</a>
        </div>
        <div style="overflow-x:auto;width:100%;">        <table id="report-table" style="min-width:2800px;width:100%;border-collapse:separate;border-spacing:0;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(25,118,210,0.06);font-size:0.98rem;">
            <thead style="position:sticky;top:0;z-index:2;">                <tr style="background:#1976d2;color:#fff;">
                    <th><input type="checkbox" id="select-all"></th>
                    <th>STT</th>
                    <th>material_id</th>
                    <th>Group use<br>Nh√≥m s·ª≠ d·ª•ng</th>
                    <th>Product code<br>M√£ h√†ng</th>
                    <th>Classify<br>Ph√¢n lo·∫°i BU</th>
                    <th>Part Code</th>
                    <th>Material name<br>T√™n h√†ng h√≥a</th>
                    <th>Specification/ Drawing<br>Th√¥ng s·ªë k·ªπ thu·∫≠t/ b·∫£n v·∫Ω</th>
                    <th>Brand<br>Nh√† SX</th>
                    <th>Unit<br>ƒê∆°n v·ªã</th>
                    <th>Opening stock<br>T·ªìn ƒë·∫ßu k·ª≥</th>
                    <th>Input<br>Nh·∫≠p</th>
                    <th>Output<br>Xu·∫•t</th>
                    <th>Closing stock<br>T·ªìn cu·ªëi k·ª≥</th>
                    <th>Inventory<br>Ki·ªÉm k√™</th>
                    <th>Location<br>V·ªã tr√≠</th>
                    <th>Safety Stock<br>T·ªìn kho an to√†n</th>
                    <th>Purchase SE<br>SE mua h√†ng</th>
                    <th>Purchase Order<br>ƒê∆°n h√†ng mua</th>
                    <th>Cost opening stock<br>Chi ph√≠ t·ªìn ƒë·∫ßu k·ª≥</th>
                    <th>Cost Input<br>Chi ph√≠ nh·∫≠p</th>
                    <th>Cost Output<br>Chi ph√≠ xu·∫•t</th>
                    <th>Cost closing stock<br>Chi ph√≠ t·ªìn cu·ªëi k·ª≥</th>
                    <th>Cost safety stock<br>Chi ph√≠ t·ªìn kho an to√†n</th>
                    <th>Price<br>Gi√°</th>
                    <th>Currency<br>Ti·ªÅn t·ªá</th>
                    <th>imported_by<br>Ng∆∞·ªùi nh·∫≠p</th>
                    <th>created_at<br>Th·ªùi gian t·∫°o</th>
                    <th>updated_at<br>Th·ªùi gian c·∫≠p nh·∫≠t</th>
                    <th>Last update<br>C·∫≠p nh·∫≠t cu·ªëi</th>
                    <th>last_time<br>Th·ªùi gian cu·ªëi</th>
                </tr>
            </thead>            <tbody>                {% for r in report %}                <tr class="report-row" data-specification="{{ r.specification }}">
                    <td><input type="checkbox" class="row-checkbox" data-specification="{{ r.specification }}"></td>
                    <td>{{ loop.index }}</td>
                    <td>{{ r.material_id }}</td>
                    <td contenteditable="false" class="editable" data-field="group_name">{{ r.group_name }}</td>
                    <td contenteditable="false" class="editable" data-field="product_code">{{ r.product_code }}</td>
                    <td contenteditable="false" class="editable" data-field="classification">{{ r.classification }}</td>
                    <td contenteditable="false" class="editable" data-field="part_code">{{ r.part_code }}</td>
                    <td contenteditable="false" class="editable" data-field="material_name">{{ r.material_name }}</td>
                    <td contenteditable="false" class="editable" data-field="specification">{{ r.specification }}</td>
                    <td contenteditable="false" class="editable" data-field="brand_name">{{ r.brand_name }}</td>
                    <td contenteditable="false" class="editable" data-field="unit">{{ r.unit }}</td>
                    <td contenteditable="false" class="editable" data-field="opening_stock">{{ r.opening_stock }}</td>
                    <td contenteditable="false" class="editable" data-field="input">{{ r.input }}</td>
                    <td contenteditable="false" class="editable" data-field="output">{{ r.output }}</td>
                    <td contenteditable="false" class="editable" data-field="closing_stock">{{ r.closing_stock }}</td>
                    <td contenteditable="false" class="editable" data-field="inventory">{{ r.inventory }}</td>
                    <td contenteditable="false" class="editable" data-field="location">{{ r.location }}</td>                    <td contenteditable="false" class="editable" data-field="safety_stock">{{ r.safety_stock }}</td>
                    <td contenteditable="false" class="editable" data-field="purchase_se">{{ r.purchase_se }}</td>
                    <td contenteditable="false" class="editable" data-field="purchase_order">{{ r.purchase_order }}</td>
                    <td contenteditable="false" class="editable" data-field="cost_opening_stock">{{ r.cost_opening_stock }}</td>
                    <td contenteditable="false" class="editable" data-field="cost_input">{{ r.cost_input }}</td>
                    <td contenteditable="false" class="editable" data-field="cost_output">{{ r.cost_output }}</td>
                    <td contenteditable="false" class="editable" data-field="cost_closing_stock">{{ r.cost_closing_stock }}</td>
                    <td contenteditable="false" class="editable" data-field="cost_safety_stock">{{ r.cost_safety_stock }}</td>
                    <td contenteditable="false" class="editable" data-field="price">{{ r.price }}</td>
                    <td contenteditable="false" class="editable" data-field="currency">{{ r.currency }}</td>
                    <td contenteditable="false" class="editable" data-field="imported_by">{{ r.imported_by }}</td>
                    <td contenteditable="false" class="editable" data-field="created_at">{{ r.created_at }}</td>
                    <td contenteditable="false" class="editable" data-field="updated_at">{{ r.updated_at }}</td>
                    <td contenteditable="false" class="editable" data-field="last_update">{{ r.last_update }}</td>                    <td contenteditable="false" class="editable" data-field="last_time">{{ r.last_time }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        <div style="text-align:center;margin-top:18px;">
            <a href="/" style="color:#1976d2;text-decoration:underline;">&larr; V·ªÅ trang ch·ªß</a>
        </div>
    </div>
</div>
<script>
    // H√†m l·∫•y th·ªùi gian hi·ªán t·∫°i ƒë·ªãnh d·∫°ng YYYY-MM-DD HH:MM:SS
    function getCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    // L·ªçc t√¨m ki·∫øm nhanh cho b·∫£ng b√°o c√°o t·ªìn kho
    document.getElementById('report-search').addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('#report-table .report-row');
        rows.forEach(row => {
            let show = false;
            row.querySelectorAll('td').forEach(td => {
                if (td.innerText.toLowerCase().includes(filter)) show = true;
            });
            row.style.display = show ? '' : 'none';
        });
    });
    // Ch·ªçn t·∫•t c·∫£
    document.getElementById('select-all').addEventListener('change', function() {
        const checked = this.checked;
        document.querySelectorAll('.row-checkbox').forEach(cb => { cb.checked = checked; });
    });
    // N√∫t x√≥a c√°c m·ª•c ƒë√£ ch·ªçn
    document.getElementById('delete-selected').onclick = async function() {
        const checked = Array.from(document.querySelectorAll('.row-checkbox:checked'));
        if (checked.length === 0) { alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ x√≥a!'); return; }
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn?')) return;
        let failList = [];
        // Disable n√∫t x√≥a ƒë·ªÉ tr√°nh double click
        const btn = document.getElementById('delete-selected');
        btn.disabled = true;        await Promise.all(checked.map(async cb => {
            const specification = cb.getAttribute('data-specification');
            try {
                const res = await fetch('/delete-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qr_code: specification })
                });
                const result = await res.json();
                if (!result.status || result.status !== 'success') {
                    failList.push(specification + (result.message ? ` (${result.message})` : ''));
                }
            } catch (e) {
                failList.push(specification + ' (L·ªói k·∫øt n·ªëi)');
            }
        }));
        btn.disabled = false;
        if (failList.length) {
            alert('M·ªôt s·ªë v·∫≠t t∆∞ kh√¥ng x√≥a ƒë∆∞·ª£c:\n' + failList.join('\n'));
        } else {
            alert('ƒê√£ x√≥a th√†nh c√¥ng!');
        }
        location.reload();
    };
    // Ch·ªânh s·ª≠a v√† l∆∞u t·ª´ng d√≤ng b√°o c√°o
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = function() {
            const row = btn.closest('tr');
            row.querySelectorAll('.editable').forEach(td => {
                // Kh√¥ng cho ph√©p ch·ªânh s·ª≠a last_update v√† last_time
                if (td.getAttribute('data-field') === 'last_update' || td.getAttribute('data-field') === 'last_time') {
                    td.contentEditable = 'false';
                } else {
                    td.contentEditable = 'true';
                    td.style.background = '#e3f0ff'; // Highlight √¥ ƒëang ch·ªânh s·ª≠a
                }
            });
            btn.disabled = true;
            btn.style.opacity = 0.6;
            row.querySelector('.save-btn').style.display = '';
            row.querySelector('.cancel-btn').style.display = '';
            // L∆∞u gi√° tr·ªã c≈© ƒë·ªÉ c√≥ th·ªÉ ho√†n t√°c v√† ƒë·ªÉ bi·∫øt kh√≥a c≈©
            row._oldValues = {};
            row.querySelectorAll('.editable').forEach(td => {
                row._oldValues[td.getAttribute('data-field')] = td.innerText;
            });
            // L∆∞u c·∫£ specification c≈© ƒë·ªÉ l√†m kh√≥a c·∫≠p nh·∫≠t
            row._oldSpec = row.querySelector('[data-field="specification"]').innerText.trim();
        };
    });
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.onclick = function() {
            const row = btn.closest('tr');
            // Ho√†n t√°c gi√° tr·ªã c≈©
            if(row._oldValues) {
                row.querySelectorAll('.editable').forEach(td => {
                    const field = td.getAttribute('data-field');
                    td.innerText = row._oldValues[field];
                    td.style.background = '';
                });
            }
            row.querySelectorAll('.editable').forEach(td => td.contentEditable = 'false');
            row.querySelector('.edit-btn').style.display = '';
            row.querySelector('.save-btn').style.display = 'none';
            row.querySelector('.cancel-btn').style.display = 'none';
            row.querySelector('.edit-btn').disabled = false;
            row.querySelector('.edit-btn').style.opacity = 1;
        };
    });
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = async function() {
            const row = btn.closest('tr');
            // Disable c√°c n√∫t khi ƒëang x·ª≠ l√Ω
            btn.disabled = true;
            btn.style.opacity = 0.6;
            row.querySelector('.cancel-btn').disabled = true;            // L·∫•y specification c≈© l√†m kh√≥a c·∫≠p nh·∫≠t
            const oldSpec = row._oldSpec || row.getAttribute('data-specification');
            const data = { old_specification: oldSpec };
            row.querySelectorAll('.editable').forEach(td => {
                // Kh√¥ng g·ª≠i last_update, last_time t·ª´ frontend (backend s·∫Ω t·ª± c·∫≠p nh·∫≠t)
                if (td.getAttribute('data-field') !== 'last_update' && td.getAttribute('data-field') !== 'last_time') {
                    data[td.getAttribute('data-field')] = td.innerText.trim();
                }
            });
            try {
                const res = await fetch('/update-bao-cao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if(result.status === 'success') {
                    // C·∫≠p nh·∫≠t l·∫°i last_update v√† last_time tr√™n giao di·ªán (d√πng th·ªùi gian hi·ªán t·∫°i)
                    const nowStr = getCurrentDateTime();
                    row.querySelector('[data-field="last_update"]').innerText = nowStr;
                    row.querySelector('[data-field="last_time"]').innerText = nowStr;
                    btn.innerText = 'ƒê√£ l∆∞u';
                    btn.style.background = '#388e3c';
                    setTimeout(()=>{btn.innerText='L∆∞u';btn.style.background='';}, 1200);
                    row.querySelectorAll('.editable').forEach(td => {
                        td.contentEditable = 'false';
                        td.style.background = '';
                    });
                    row.querySelector('.edit-btn').style.display = '';
                    btn.style.display = 'none';
                    row.querySelector('.cancel-btn').style.display = 'none';
                    row.querySelector('.edit-btn').disabled = false;
                    row.querySelector('.edit-btn').style.opacity = 1;
                    // C·∫≠p nh·∫≠t l·∫°i data-part-code n·∫øu specification ƒë·ªïi
                    row.setAttribute('data-part-code', data['specification']);
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                } else {
                    btn.innerText = 'L·ªói';
                    btn.style.background = '#d32f2f';
                    alert('L·ªói: ' + (result.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
                    setTimeout(()=>{btn.innerText='L∆∞u';btn.style.background='';}, 1200);
                }
            } catch (err) {
                console.error('L·ªói khi g·ªçi API:', err);
                alert('L·ªói m·∫°ng ho·∫∑c server. Vui l√≤ng th·ª≠ l·∫°i!');
            } finally {
                btn.disabled = false;
                btn.style.opacity = 1;
                row.querySelector('.cancel-btn').disabled = false;
            }
        };
    });
    document.getElementById('save-all-btn').onclick = async function() {
        const rows = document.querySelectorAll('#report-table .report-row');
        let successCount = 0, failCount = 0;        for (const row of rows) {
            const specification = row.getAttribute('data-specification');
            const data = { old_specification: specification };
            row.querySelectorAll('.editable').forEach(td => {
                data[td.getAttribute('data-field')] = td.innerText.trim();
            });
            const res = await fetch('/update-bao-cao', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if(result.status === 'success') successCount++; else failCount++;
        }
        alert(`ƒê√£ l∆∞u ${successCount} d√≤ng th√†nh c√¥ng${failCount ? (', ' + failCount + ' d√≤ng l·ªói!') : ''}`);
        location.reload();    };
</script>
    <footer class="footer">
        Ph√°t tri·ªÉn b·ªüi SEQPE
    </footer>
</body>
</html>
